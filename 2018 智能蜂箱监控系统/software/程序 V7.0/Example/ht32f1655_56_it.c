//------------------My_interrupt.c---------------------//
#include "ht32.h"
#include "ht32_board.h"
#include "usart_int.h"
#include "UART.h"
#include "INIT.h"
#include "DELAY.h"



unsigned int WASHING_count;                             //∂® ±∆˜«Âœ¥£¨º∆ ˝÷µLED3
unsigned int HEAT_count;                                //∂® ±º”»»£¨º∆ ˝÷µ
unsigned int FEED_count;                                //∂® ±Œπ ≥£¨º∆ ˝÷µ
extern unsigned char STEER_START_RUN_FLAG;              //∂Êª˙ø™ º‘À◊™±Í÷æŒª,0±Ì æÕ£÷π‘À◊™£¨1±Ì æø™ º‘À◊™
extern bool          HEAT_START_FLAG;                   //ø™ ºøÿ÷∆º”»»Àøº”»»±Í÷æŒª
extern bool          FEED_START_FLAG;                   //ø™ ºŒπ ≥∑‰œ‰±Í÷æŒª
extern bool          START_WASHING_FLAG;                //ø™ º«Âœ¥∑‰œ‰±Í÷æŒª
extern unsigned  int Washing_Time;                      //«Âœ¥ ±º‰£¨”……œŒªª˙∏¯∂®
extern unsigned  int Heat_Time;                         //º”»» ±º‰£¨”……œŒªª˙∏¯∂®£¨µ•Œª√Î
extern unsigned  int Feed_Time;                         //Œπ ≥ ±º‰£¨”……œŒªª˙∏¯∂®£¨µ•Œª√Î
extern unsigned  int SECOND_Count;                              //∂® ±√Î ±º‰º∆ ˝
u16 time1ms,time5ms=0,time10ms=0;
u8 Stolen[]={0xAA,0x55,0x04,0x00,0x01,0x0B,0x0F};   //±ªµ¡÷∏¡//∂® ±√Î ±º‰º∆ ˝
u8 Wifi_Icon_ON[]={0x70,0x30,0x2E,0x70,0x69,0x63,0x3D,0x35,0x30,0xff,0xff,0xff};//Õº±Í WIFI p0.pic=50 >>GREEN   “—¡¨Ω”
u8 Wifi_Icon_OFF[]={0x70,0x30,0x2E,0x70,0x69,0x63,0x3D,0x34,0x39,0xff,0xff,0xff};//Õº±Í WIFI p0.pic=49 >>RED    Œ¥¡¨Ω”
void Be_Stolen(void);
extern u8 recv1_data_ok;                //Ω” ’µΩ’˝»∑µƒ ˝æ›∞¸
extern void DataBuffer_Deal(void);


//void BFTM1_IRQHandler(void)
//{
//	BFTM_ClearFlag(HT_BFTM1);
//	SECOND_Count++;
//}
void BFTM0_IRQHandler(void)   //∂® ±∆˜0÷–∂œ
{

	BFTM_ClearFlag(HT_BFTM0);//«Â≥˝±Í÷æŒª

  time5ms++;
	time10ms++;

	if(time5ms == 200)
	{		
		Be_Stolen();  //±ªµ¡Ã· æ
		time5ms=0;
		UART_Send_Temp();   //∏¸–¬Œ¬∂» ˝÷µ
		UART_SEND_Weight(); //∏¸–¬÷ÿ¡ø ˝÷µ
		if(recv1_data_ok == 1)
		{
			USART_Sends(HT_USART1,Wifi_Icon_ON,sizeof(Wifi_Icon_ON));				 //¥Æø⁄∆¡…œœ‘ æ WIFI  “—¡¨Ω”
		}
		else{USART_Sends(HT_USART1,Wifi_Icon_OFF,sizeof(Wifi_Icon_OFF));}  //¥Æø⁄∆¡…œœ‘ æ WIFI  Œ¥¡¨Ω”
		
	}

	if(time10ms == 50) //500ms
	{
		LED1=!LED1;

		if(START_WASHING_FLAG==TRUE)
		  {
				WASHING_count++;
			  if(WASHING_count>=(Washing_Time*4))                  //«Âœ¥60S∂® ± ±º‰µΩ 
			   {
				   WASHING_count=0;
					 Washing_Time=0;                                //«Âœ¥ÕÍ≥…£¨«Âœ¥ ±º‰«Â0
				   GPIO_WriteOutBits(HT_GPIOC, GPIO_PIN_12, RESET); 			 // ‰≥ˆµÕ£¨øÿ÷∆µÁ¥≈∑ß1∂œø™£¨Õ£÷πΩ¯ÀÆ	
					 START_WASHING_FLAG=FALSE;                      //ø™ º«Âœ¥±Í÷æŒª«Â0 
		      }
	   	}
			if(HEAT_START_FLAG==TRUE)
			{
		    	HEAT_count++;
				  if(HEAT_count>=(Heat_Time*4))                      //º”»»Àøº”»» ±º‰µΩÕ£÷πº”»»
					{
						Heat_Time=0;                                 //º”»» ±º‰«Â0
					  HEAT_count=0;                                //º”»» ±º‰º∆ ˝÷µ«Â0
						
						GPIO_WriteOutBits(HT_GPIOC, GPIO_PIN_9, RESET);            //PC9“˝Ω≈÷√0£¨πÿ±’º”»»
						GPIO_WriteOutBits(HT_GPIOC, GPIO_PIN_10, RESET);           //PC10“˝Ω≈÷√0£¨πÿ±’º”»»
						HEAT_START_FLAG=FALSE;                       //ø™ ºº”»»±Í÷æŒª«Â0
					}
			}
			if(FEED_START_FLAG==TRUE)
			{
		    	FEED_count++;
				  if(FEED_count>=(Feed_Time*4))                      //º”»»Àøº”»» ±º‰µΩÕ£÷πº”»»
					{
						Feed_Time=0;                                 //º”»» ±º‰«Â0
					  FEED_count=0;                                //º”»» ±º‰º∆ ˝÷µ«Â0

						GPIO_WriteOutBits(HT_GPIOC, GPIO_PIN_11, RESET);              //PC11“˝Ω≈÷√0£¨πÿ±’Œπ ≥
						FEED_START_FLAG=FALSE;                       //ø™ ºº”»»±Í÷æŒª«Â0
					}
			}
	
			time10ms=0;
		}

}

void Be_Stolen()
{
	if(GATE == 0)
	{
			Stolen[4]=FX_NUMBER;
		
			USART_Sends(HT_USART0,Stolen,sizeof(Stolen));//œÚ…œŒªª˙∑¢ÀÕ±ªµ¡–≈œ¢
	}
}





/* Global functions ----------------------------------------------------------------------------------------*/
/*********************************************************************************************************//**
 * @brief   This function handles NMI exception.
 * @retval  None
 ************************************************************************************************************/
void NMI_Handler(void)
{
}

/*********************************************************************************************************//**
 * @brief   This function handles Hard Fault exception.
 * @retval  None
 ************************************************************************************************************/
void HardFault_Handler(void)
{
  while (1);
}

/*********************************************************************************************************//**
 * @brief   This function handles Memory Manage exception.
 * @retval  None
 ************************************************************************************************************/
void MemManage_Handler(void)
{
  while (1);
}

/*********************************************************************************************************//**
 * @brief   This function handles Bus Fault exception.
 * @retval  None
 ************************************************************************************************************/
void BusFault_Handler(void)
{
  while (1);
}

/*********************************************************************************************************//**
 * @brief   This function handles Usage Fault exception.
 * @retval  None
 ************************************************************************************************************/
void UsageFault_Handler(void)
{
  while (1);
}

/*********************************************************************************************************//**
 * @brief   This function handles SVCall exception.
 * @retval  None
 ************************************************************************************************************/
void SVC_Handler(void)
{
}

/*********************************************************************************************************//**
 * @brief   This function handles Debug Monitor exception.
 * @retval  None
 ************************************************************************************************************/
void DebugMon_Handler(void)
{
}

/*********************************************************************************************************//**
 * @brief   This function handles PendSVC exception.
 * @retval  None
 ************************************************************************************************************/
void PendSV_Handler(void)
{
}

/*********************************************************************************************************//**
 * @brief   This function handles SysTick Handler.
 * @retval  None
 ************************************************************************************************************/
//void SysTick_Handler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Clock Ready interrupt.
 * @retval  None
 ************************************************************************************************************/
//void CKRDY_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Low Voltage Detection interrupt.
 * @retval  None
 ************************************************************************************************************/
//void LVD_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Brown Out Detection interrupt.
 * @retval  None
 ************************************************************************************************************/
//void BOD_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles WDT interrupt.
 * @retval  None
 ************************************************************************************************************/
//void WDT_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles RTC interrupt.
 * @retval  None
 ************************************************************************************************************/
//void RTC_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Flash interrupt.
 * @retval  None
 ************************************************************************************************************/
//void FLASH_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Event Wake Up interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EVWUP_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles WAKEUP pin interrupt.
 * @retval  None
 ************************************************************************************************************/
//void LPWUP_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI2 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI2_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI3 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI3_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI4 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI4_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI5 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI5_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI6 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI6_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI7 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI7_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI8 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI8_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI9 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI9_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI10 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI10_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI11 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI11_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI12 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI12_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI13 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI13_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI14 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI14_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles EXTI15 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EXTI15_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Comparator interrupt.
 * @retval  None
 ************************************************************************************************************/
//void COMP_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles ADC interrupt.
 * @retval  None
 ************************************************************************************************************/
//void ADC_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM0 BRK interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM0BRK_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM0 UP interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM0UP_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM0 TR interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM0TR_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM0 CC interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM0CC_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM1 BRK interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM1BRK_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM1 UP interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM1UP_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM1 TR interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM1TR_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles MCTM1 CC interrupt.
 * @retval  None
 ************************************************************************************************************/
//void MCTM1CC_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles General Purpose Timer 0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void GPTM0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles General Purpose Timer 1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void GPTM1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Basic Function Timer 0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void BFTM0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Basic Function Timer 1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void BFTM1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles I2C0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void I2C0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles I2C1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void I2C1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles SPI0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void SPI0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles SPI1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void SPI1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles USART0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void USART0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles USART1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void USART1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles UART0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void UART0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles UART1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void UART1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles Smart Card interrupt.
 * @retval  None
 ************************************************************************************************************/
//void SCI_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles I2S interrupt.
 * @retval  None
 ************************************************************************************************************/
//void I2S_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles USB interrupt.
 * @retval  None
 ************************************************************************************************************/
//void USB_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH0 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH0_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH1 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH1_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH2 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH2_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH3 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH3_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH4 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH4_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH5 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH5_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH6 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH6_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles PDMA_CH7 interrupt.
 * @retval  None
 ************************************************************************************************************/
//void PDMA_CH7_IRQHandler(void)
//{
//}

/*********************************************************************************************************//**
 * @brief   This function handles External Bus Interface interrupt.
 * @retval  None
 ************************************************************************************************************/
//void EBI_IRQHandler(void)
//{
//}


/**
  * @}
  */

/**
  * @}
  */

/**
  * @}
  */
	
	
